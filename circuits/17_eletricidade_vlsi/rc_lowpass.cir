* ============================================================================
* Circuito: Filtro Passa-Baixa RC - Analise de Resposta em Frequencia
* ============================================================================
* Este circuito demonstra um filtro passa-baixa de primeira ordem usando
* um resistor e um capacitor. O filtro atenua sinais de alta frequencia
* enquanto permite a passagem de baixas frequencias.
* ============================================================================

* ----------------------------------------------------------------------------
* Fonte de sinal AC
* ----------------------------------------------------------------------------
* Fonte com amplitude de 1V para facilitar leitura do ganho em dB
* A fase inicial e 0 graus
Vin  vin 0  AC 1

* ----------------------------------------------------------------------------
* Resistor serie
* ----------------------------------------------------------------------------
* O resistor limita a corrente e, junto com o capacitor, define a
* frequencia de corte do filtro: fc = 1/(2*pi*R*C)
R1   vin vout  50              ; Resistor de 50 Ohms

* ----------------------------------------------------------------------------
* Capacitor em paralelo com a saida
* ----------------------------------------------------------------------------
* O capacitor desvia altas frequencias para o terra
* Em baixas frequencias: Xc = 1/(2*pi*f*C) e muito alto (circuito aberto)
* Em altas frequencias: Xc diminui (curto-circuito)
C1   vout 0   53u              ; Capacitor de 53 uF

* ============================================================================
* CALCULOS TEORICOS
* ============================================================================
* Frequencia de corte (-3 dB):
*   fc = 1/(2*pi*R*C)
*   fc = 1/(2*pi*50*53e-6)
*   fc = 1/(2*pi*0.00265)
*   fc = 1/(0.01665)
*   fc = 60.06 Hz (aproximadamente 60 Hz)
*
* Constante de tempo:
*   tau = R * C = 50 * 53e-6 = 2.65 ms
*
* Funcao de transferencia:
*   H(s) = 1/(1 + s*R*C) = 1/(1 + s*tau)
*
* Magnitude em funcao da frequencia:
*   |H(f)| = 1/sqrt(1 + (f/fc)^2)
*
* Fase em funcao da frequencia:
*   phi(f) = -arctan(f/fc)
*
* Caracteristicas do filtro de primeira ordem:
*   - Na frequencia de corte (fc): ganho = -3 dB, fase = -45 graus
*   - Taxa de atenuacao: -20 dB/decada apos fc
*   - Fase varia de 0 graus (f << fc) ate -90 graus (f >> fc)
* ============================================================================

* ----------------------------------------------------------------------------
* Analise de Frequencia (AC Analysis)
* ----------------------------------------------------------------------------
* Sintaxe: .ac <tipo> <num_pontos> <freq_inicial> <freq_final>
*
* DEC = escala logaritmica (decada) - pontos por decada
* 50 pontos por decada garante uma curva suave
* Faixa: 1Hz a 10kHz (cobre bem abaixo e acima da freq. de corte de ~60 Hz)
.ac dec 50 1 10k

* Variaveis a salvar
.save V(vin) V(vout)

* ----------------------------------------------------------------------------
* Comandos de controle e plotagem
* ----------------------------------------------------------------------------
.control
run

* ========================================================================
* DIAGRAMA DE BODE - MAGNITUDE
* ========================================================================
* vdb(vout) = 20*log10(|V(vout)/1V|) em decibeis
* Em frequencias baixas: ganho proximo de 0 dB (sinal passa sem atenuacao)
* Em frequencias altas: ganho cai -20 dB/decada (filtro de 1a ordem)
* Na frequencia de corte (~60 Hz): ganho = -3 dB
echo " "
echo "=== DIAGRAMA DE BODE - MAGNITUDE ==="
plot vdb(vout) title "Filtro Passa-Baixa RC - Magnitude" xlabel "Frequencia (Hz)" ylabel "Ganho (dB)"

* ========================================================================
* DIAGRAMA DE BODE - FASE
* ========================================================================
* A fase varia de 0 graus (baixas freq.) ate -90 graus (altas freq.)
* Na frequencia de corte (~60 Hz): fase = -45 graus
* Conversao: phase() retorna radianos, multiplicamos por 180/pi para graus
echo " "
echo "=== DIAGRAMA DE BODE - FASE ==="
plot phase(vout)*180/pi title "Filtro Passa-Baixa RC - Fase" xlabel "Frequencia (Hz)" ylabel "Fase (graus)"

* ========================================================================
* DIAGRAMA DE BODE COMPLETO (MAGNITUDE E FASE JUNTAS)
* ========================================================================
echo " "
echo "=== DIAGRAMA DE BODE COMPLETO ==="
plot vdb(vout) phase(vout)*180/pi title "Diagrama de Bode - Filtro RC (R=50 Ohms, C=53uF)" xlabel "Frequencia (Hz)"

* ========================================================================
* INFORMACOES DO FILTRO NA TELA
* ========================================================================
echo " "
echo "========================================================"
echo "  PARAMETROS DO FILTRO PASSA-BAIXA RC"
echo "========================================================"
echo "  R = 50 Ohms"
echo "  C = 53 uF"
echo " "
echo "  Constante de tempo (tau): 2.65 ms"
echo "  Frequencia de corte (fc): ~60 Hz"
echo " "
echo "  Na frequencia de corte:"
echo "    - Ganho: -3 dB (70.7% da amplitude)"
echo "    - Fase: -45 graus"
echo " "
echo "  Taxa de atenuacao: -20 dB/decada (filtro 1a ordem)"
echo "========================================================"
echo " "

* ========================================================================
* MEDICOES AUTOMATICAS (opcional)
* ========================================================================
* Comando MEAS (measure): extrai valores especificos dos resultados da simulacao
*
* Sintaxe geral:
*   meas <tipo_analise> <nome_resultado> <operacao> <expressao> <condicao>
*
* Parametros:
*   <tipo_analise>: tipo da analise (ac, dc, tran)
*   <nome_resultado>: nome da variavel que armazenara o resultado da medicao
*   <operacao>: tipo de medicao a realizar
*   <expressao>: o que medir (ex: vdb(vout), fase_graus)
*   <condicao>: quando/onde medir
*
* Operacoes principais:
*   find <vetor> at=<valor>   : encontra o valor do vetor em um ponto especifico
*                               Exemplo: find vdb(vout) at=60
*                               -> retorna o ganho em dB na frequencia de 60Hz
*
*   find <vetor> when <cond>  : encontra o valor do vetor quando uma condicao e verdadeira
*                               Exemplo: find fase_graus when vdb(vout)=-3
*                               -> retorna a fase quando o ganho for -3dB
*
*   when <condicao>           : encontra o valor da variavel independente (ex: frequencia)
*                               quando uma condicao e satisfeita
*                               Exemplo: when vdb(vout)=-3
*                               -> retorna a frequencia onde o ganho e -3dB
*
* ========================================================================

* Medir o ganho e fase em pontos especificos
echo "=== MEDICOES EM FREQUENCIAS ESPECIFICAS ==="
meas ac ganho_1Hz find vdb(vout) at=1
meas ac ganho_60Hz find vdb(vout) at=60
meas ac ganho_600Hz find vdb(vout) at=600
* Criar vetor de fase em graus para as medicoes
let fase_graus = phase(vout)*180/pi
meas ac fase_1Hz find fase_graus at=1
meas ac fase_60Hz find fase_graus at=60
meas ac fase_600Hz find fase_graus at=600

* ========================================================================
* VERIFICACAO DA FREQUENCIA DE CORTE
* ========================================================================
echo " "
echo "=== VERIFICACAO DA FREQUENCIA DE CORTE ==="
* Frequencia teorica de corte
let fc_teorica = 1/(2*pi*50*53e-6)
echo "Frequencia de corte teorica: $&fc_teorica Hz"

* Medir a frequencia onde o ganho e -3dB (definicao de freq. de corte)
meas ac fc_medida when vdb(vout)=-3
echo "Frequencia de corte medida (ganho = -3dB): $&fc_medida Hz"

* Calcular o erro percentual
let erro_percentual = abs((fc_medida - fc_teorica) / fc_teorica * 100)
echo "Erro percentual: $&erro_percentual %"

* Verificar se o erro esta dentro de uma tolerancia aceitavel (< 1%)
if erro_percentual < 1
  echo "✓ PASSOU: Frequencia de corte esta dentro da tolerancia (< 1%)"
else
  echo "✗ FALHOU: Frequencia de corte fora da tolerancia esperada"
end

* Medir a fase na frequencia de corte medida
meas ac fase_fc find fase_graus when vdb(vout)=-3
echo "Fase na frequencia de corte: $&fase_fc graus (esperado: -45 graus)"

* Verificar se a fase esta proxima de -45 graus (tolerancia de 1 grau)
let erro_fase = abs(fase_fc - (-45))
if erro_fase < 1
  echo "✓ PASSOU: Fase na frequencia de corte esta correta (≈ -45°)"
else
  echo "✗ FALHOU: Fase na frequencia de corte = $&fase_fc° (esperado: -45°)"
end

echo " "

.endc

.end
